<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>AK Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            font-size: 0.95rem;
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            background-color: #fff;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .radio-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            margin-top: 20px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: normal;
            cursor: pointer;
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 25px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* Result Styles */
        #result-area {
            margin-top: 25px;
            background-color: #ffffff;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }
        
        #result-area.active {
            display: block;
        }

        .result-header {
            background-color: #f1f3f5;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #555;
        }

        .result-row.main {
            font-weight: bold;
            color: #333;
            font-size: 1rem;
            margin-top: 5px;
        }

        .result-body {
            padding: 15px;
        }

        .tier-row {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tier-label {
            font-weight: 600;
            color: #333;
        }

        .tier-detail {
            font-size: 0.85rem;
            color: #777;
        }

        .result-footer {
            background-color: #f8f9fa;
            padding: 15px;
            border-top: 1px solid #ddd;
        }
        
        .reconciliation {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            font-size: 0.85rem;
            color: #666;
            text-align: right;
        }

        .error-msg {
            color: #d9534f;
            font-weight: bold;
            padding: 15px;
            background: #fff5f5;
            border: 1px solid #ffcccc;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>AK Calculator</h2>

    <div class="form-group">
        <label for="players">Number of Players:</label>
        <input id="players" placeholder="e.g. 50" type="number">
    </div>

    <div class="form-group">
        <label for="cost">Entry Fee (Gold):</label>
        <input id="cost" placeholder="e.g. 1000" type="number">
    </div>

    <div class="form-group">
        <label for="house">House Taken (%):</label>
        <input id="house" type="number" value="10">
    </div>

    <div class="form-group">
        <label>Define Winners by:</label>
        <div class="radio-group">
            <label><input checked name="winnerMode" type="radio" value="1"> Fixed Number</label>
            <label><input name="winnerMode" type="radio" value="2"> Percentage (%)</label>
        </div>
    </div>

    <div class="form-group">
        <label for="winnersVal">Winners (Count or %):</label>
        <input id="winnersVal" placeholder="e.g. 5" type="number">
    </div>

    <div class="form-group">
        <label for="tiers">Number of Tiers:</label>
        <input id="tiers" placeholder="Default: 1" type="number">
    </div>

    <div class="settings-grid">
        <div class="form-group">
            <label for="peopleMode">People Structure:</label>
            <select id="peopleMode">
                <option value="equal">Equal</option>
                <option value="linear" selected>Pyramid (Staggered)</option>
                <option value="exp">Halving (Exponential)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="prizeMode">Prize Structure:</label>
            <select id="prizeMode">
                <option value="linear" selected>Linear (Staggered)</option>
                <option value="exp">Doubling (Exponential)</option>
            </select>
        </div>
    </div>

    <div class="checkbox-group">
        <label>
            <input id="round10" type="checkbox" checked> Round Payouts to Nearest 10
        </label>
    </div>

    <button onclick="calculatePayout()">Calculate Payout</button>

    <!-- Results Display -->
    <div id="error-area"></div>
    <div id="result-area"></div>
</div>

<script>
    // Helper to add commas to numbers
    function fmt(num) {
        return num.toLocaleString();
    }

    function calculatePayout() {
        const errorArea = document.getElementById('error-area');
        const resultArea = document.getElementById('result-area');
        
        errorArea.innerHTML = '';
        resultArea.innerHTML = '';
        resultArea.classList.remove('active');

        // --- 1. Get Inputs ---
        const players = parseInt(document.getElementById('players').value);
        const cost = parseInt(document.getElementById('cost').value);
        const housePercent = parseFloat(document.getElementById('house').value);
        const rawWinnerVal = parseFloat(document.getElementById('winnersVal').value);
        let tiers = parseInt(document.getElementById('tiers').value);
        
        const peopleMode = document.getElementById('peopleMode').value;
        const prizeMode = document.getElementById('prizeMode').value;
        const roundDown10 = document.getElementById('round10').checked;

        // Validation
        if (isNaN(players) || isNaN(cost) || isNaN(housePercent) || isNaN(rawWinnerVal)) {
            errorArea.innerHTML = '<div class="error-msg">Please ensure all fields have valid numbers.</div>';
            return;
        }

        // --- 2. Calculate Winners ---
        const modes = document.getElementsByName('winnerMode');
        let winnerMode = 1;
        for (let mode of modes) { if (mode.checked) winnerMode = parseInt(mode.value); }

        let totalWinners;
        if (winnerMode === 2) {
            const calcCount = players * (rawWinnerVal / 100);
            totalWinners = Math.max(1, Math.round(calcCount));
        } else {
            totalWinners = Math.floor(rawWinnerVal);
        }

        if (totalWinners > players) totalWinners = players;
        if (isNaN(tiers) || tiers < 1) tiers = 1;
        if (tiers > totalWinners) tiers = totalWinners;

        // --- 3. Distribute PEOPLE into Tiers ---
        // Array index 0 = Top Tier. Index T-1 = Bottom Tier.
        
        let peopleWeights = [];
        if (peopleMode === 'equal') {
            peopleWeights = new Array(tiers).fill(1);
        } else if (peopleMode === 'linear') {
            // Weights: 1, 2, 3... (Top gets 1, Bottom gets max)
            for (let i = 1; i <= tiers; i++) peopleWeights.push(i);
        } else if (peopleMode === 'exp') {
            // Weights: 1, 2, 4...
            for (let i = 0; i < tiers; i++) peopleWeights.push(Math.pow(2, i));
        }

        // Use Largest Remainder Method for People integers
        let totalWeightP = peopleWeights.reduce((a, b) => a + b, 0);
        let tierCounts = peopleWeights.map(w => Math.floor(totalWinners * (w / totalWeightP)));
        let currentCount = tierCounts.reduce((a, b) => a + b, 0);
        let remainderP = totalWinners - currentCount;
        let decimals = peopleWeights.map(w => (totalWinners * (w / totalWeightP)) % 1);
        
        while (remainderP > 0) {
            let maxIndex = decimals.indexOf(Math.max(...decimals));
            tierCounts[maxIndex]++;
            decimals[maxIndex] = -1; 
            remainderP--;
        }

        // --- 4. Distribute PRIZE MONEY ---
        
        const grossPot = players * cost;
        const houseInitialFee = Math.floor(grossPot * (housePercent / 100));
        let netPrizePool = grossPot - houseInitialFee;

        // SMART ROUNDING PREP: 
        // If rounding to 10, try to reserve 10 gold for everyone first so Bottom tier isn't 0.
        let basePayouts = new Array(tiers).fill(0);
        
        if (roundDown10) {
            const minRequired = totalWinners * 10;
            if (netPrizePool >= minRequired) {
                basePayouts.fill(10);
                netPrizePool -= minRequired; // We distribute the rest as bonus
            }
        }

        // Calculate Weights for the remaining NetPot
        let prizeWeights = [];
        if (prizeMode === 'linear') {
            // Weights: T, T-1, ..., 1. (Top tier gets max weight)
            for (let i = 0; i < tiers; i++) prizeWeights.push(tiers - i);
        } else if (prizeMode === 'exp') {
            // Weights: 2^(T-1) down to 1
            for (let i = 0; i < tiers; i++) prizeWeights.push(Math.pow(2, tiers - 1 - i));
        } else {
             // Fallback if 'equal' somehow selected, though hidden
             prizeWeights = new Array(tiers).fill(1);
        }

        let totalFactor = 0;
        for(let i=0; i<tiers; i++) {
            totalFactor += tierCounts[i] * prizeWeights[i];
        }
        if (totalFactor === 0) totalFactor = 1;

        const unitValue = Math.floor(netPrizePool / totalFactor);
        
        // These are the "Bonus" payouts
        let tierPayouts = prizeWeights.map(w => w * unitValue);

        // --- 5. Optimization Loop (Spend Loose Change) ---
        let usedGold = 0;
        for (let i = 0; i < tiers; i++) usedGold += tierPayouts[i] * tierCounts[i];
        let leftoverGold = netPrizePool - usedGold;

        // Fill loose change into top tiers
        let changeMade = true;
        while (changeMade && leftoverGold > 0) {
            changeMade = false;
            for (let i = 0; i < tiers; i++) {
                const costToBump = tierCounts[i];
                if (leftoverGold >= costToBump) {
                    tierPayouts[i] += 1;
                    leftoverGold -= costToBump;
                    changeMade = true;
                }
            }
        }

        // --- 6. Apply Rounding to the "Bonus" ---
        if (roundDown10) {
            let roundingPot = leftoverGold;
            
            for (let i = 0; i < tiers; i++) {
                const originalVal = tierPayouts[i];
                const roundedVal = Math.floor(originalVal / 10) * 10;
                tierPayouts[i] = roundedVal;
                roundingPot += ((originalVal - roundedVal) * tierCounts[i]);
            }

            // Distribute rounding pot in chunks of 10
            changeMade = true;
            while (changeMade && roundingPot > 0) {
                changeMade = false;
                for (let i = 0; i < tiers; i++) {
                    const costToBump10 = tierCounts[i] * 10;
                    if (roundingPot >= costToBump10) {
                        tierPayouts[i] += 10;
                        roundingPot -= costToBump10;
                        changeMade = true;
                    }
                }
            }
            leftoverGold = roundingPot;
        }

        // --- 7. Combine Base (10) + Bonus ---
        for(let i=0; i<tiers; i++) {
            tierPayouts[i] += basePayouts[i];
        }

        // --- 8. HTML Output ---
        let tiersHtml = '';
        let totalPaidOut = 0;

        for(let i = 0; i < tiers; i++) {
            if (tierCounts[i] === 0) continue;

            const payout = tierPayouts[i];
            const count = tierCounts[i];
            const subTotal = payout * count;
            totalPaidOut += subTotal;

            tiersHtml += `
            <div class="tier-row">
                <div>
                    <div class="tier-label">Tier ${i + 1}</div>
                    <div class="tier-detail">${count} people</div>
                </div>
                <div style="text-align:right">
                    <div class="tier-label" style="color:#007bff">${fmt(payout)} G</div>
                    <div class="tier-detail">Total: ${fmt(subTotal)} G</div>
                </div>
            </div>`;
        }

        // Net Pool Calculation for display needs to account for the logic split
        // Real Net Pool = Gross - Initial Fee.
        const displayNetPool = grossPot - houseInitialFee;
        const totalHouseTake = houseInitialFee + leftoverGold;
        
        const html = `
            <div class="result-header">
                <div class="result-row">
                    <span>Gross Pot:</span>
                    <span>${fmt(grossPot)}</span>
                </div>
                <div class="result-row">
                    <span>Initial House Fee (${housePercent}%):</span>
                    <span style="color:#d9534f">-${fmt(houseInitialFee)}</span>
                </div>
                <div class="result-row main">
                    <span>Net Prize Pool:</span>
                    <span>${fmt(displayNetPool)}</span>
                </div>
            </div>

            <div class="result-body">
                ${tiersHtml}
            </div>

            <div class="result-footer">
                <div class="result-row">
                    <span>Total Distributed to Players:</span>
                    <strong>${fmt(totalPaidOut)}</strong>
                </div>
                <div class="result-row">
                    <span>Rounding Leftovers (to House):</span>
                    <span>+${fmt(leftoverGold)}</span>
                </div>
                <div class="result-row main">
                    <span>Total House Take (Fee + Rounding):</span>
                    <span>${fmt(totalHouseTake)}</span>
                </div>
                <div class="reconciliation">
                    Check: Distributed (${fmt(totalPaidOut)}) + House (${fmt(totalHouseTake)}) = ${fmt(totalPaidOut + totalHouseTake)}
                </div>
            </div>
        `;

        resultArea.innerHTML = html;
        resultArea.classList.add('active');
    }
</script>

</body>
</html>