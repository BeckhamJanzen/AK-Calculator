<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>AK Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            font-size: 0.95rem;
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .radio-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .checkbox-group {
            margin-top: 20px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: normal;
            cursor: pointer;
            margin-bottom: 8px;
        }
        
        .checkbox-group label:last-child {
            margin-bottom: 0;
        }

        button {
            width: 100%;
            padding: 14px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 25px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* Result Styles */
        #result-area {
            margin-top: 25px;
            background-color: #ffffff;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            overflow: hidden;
            display: none; /* Hidden by default */
        }
        
        #result-area.active {
            display: block;
        }

        .result-header {
            background-color: #f1f3f5;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #555;
        }

        .result-row.main {
            font-weight: bold;
            color: #333;
            font-size: 1rem;
            margin-top: 5px;
        }

        .result-row.highlight {
            color: #007bff;
        }

        .result-body {
            padding: 15px;
        }

        .tier-row {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tier-label {
            font-weight: 600;
            color: #333;
        }

        .tier-detail {
            font-size: 0.85rem;
            color: #777;
        }

        .result-footer {
            background-color: #f8f9fa;
            padding: 15px;
            border-top: 1px solid #ddd;
        }
        
        .reconciliation {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            font-size: 0.85rem;
            color: #666;
            text-align: right;
        }

        .error-msg {
            color: #d9534f;
            font-weight: bold;
            padding: 15px;
            background: #fff5f5;
            border: 1px solid #ffcccc;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>AK Calculator</h2>

    <div class="form-group">
        <label for="players">Number of Players:</label>
        <input id="players" placeholder="e.g. 50" type="number">
    </div>

    <div class="form-group">
        <label for="cost">Entry Fee (Gold):</label>
        <input id="cost" placeholder="e.g. 1000" type="number">
    </div>

    <div class="form-group">
        <label for="house">House Taken (%):</label>
        <input id="house" type="number" value="10">
    </div>

    <div class="form-group">
        <label>Define Winners by:</label>
        <div class="radio-group">
            <label><input checked name="winnerMode" type="radio" value="1"> Fixed Number</label>
            <label><input name="winnerMode" type="radio" value="2"> Percentage (%)</label>
        </div>
    </div>

    <div class="form-group">
        <label for="winnersVal">Winners (Count or %):</label>
        <input id="winnersVal" placeholder="e.g. 5" type="number">
    </div>

    <div class="form-group">
        <label for="tiers">Number of Tiers (Optional):</label>
        <input id="tiers" placeholder="Default: 1" type="number">
    </div>

    <div class="checkbox-group">
        <label>
            <input id="halving" type="checkbox"> Enable Halving Mode
        </label>
        <label>
            <input id="round10" type="checkbox"> Round to Nearest 10
        </label>
    </div>

    <button onclick="calculatePayout()">Calculate Payout</button>

    <!-- Results Display -->
    <div id="error-area"></div>
    <div id="result-area"></div>
</div>

<script>
    // Helper to add commas to numbers
    function fmt(num) {
        return num.toLocaleString();
    }

    function calculatePayout() {
        const errorArea = document.getElementById('error-area');
        const resultArea = document.getElementById('result-area');
        
        // Reset displays
        errorArea.innerHTML = '';
        resultArea.innerHTML = '';
        resultArea.classList.remove('active');

        // Inputs
        const players = parseInt(document.getElementById('players').value);
        const cost = parseInt(document.getElementById('cost').value);
        const housePercent = parseFloat(document.getElementById('house').value);
        const rawWinnerVal = parseFloat(document.getElementById('winnersVal').value);
        let tiers = parseInt(document.getElementById('tiers').value);
        
        const useHalving = document.getElementById('halving').checked;
        const roundDown10 = document.getElementById('round10').checked;

        // Validation
        if (isNaN(players) || isNaN(cost) || isNaN(housePercent) || isNaN(rawWinnerVal)) {
            errorArea.innerHTML = '<div class="error-msg">Please ensure all fields have valid numbers.</div>';
            return;
        }

        // Determine number of winners
        const modes = document.getElementsByName('winnerMode');
        let winnerMode = 1;
        for (let mode of modes) {
            if (mode.checked) winnerMode = parseInt(mode.value);
        }

        let totalWinners;
        if (winnerMode === 2) {
            const calcCount = players * (rawWinnerVal / 100);
            totalWinners = Math.max(1, Math.round(calcCount));
        } else {
            totalWinners = Math.floor(rawWinnerVal);
        }

        // Logical cap on winners
        if (totalWinners > players) {
            totalWinners = players;
        }

        if (isNaN(tiers) || tiers < 1) tiers = 1;
        if (tiers > totalWinners) {
            tiers = totalWinners; // Silently fix tier cap
        }

        // Financials
        const grossPot = players * cost;
        const houseInitialFee = Math.floor(grossPot * (housePercent / 100));
        const netPrizePool = grossPot - houseInitialFee;

        // Tier Distribution Logic
        const baseCount = Math.floor(totalWinners / tiers);
        const remainder = totalWinners % tiers;

        let tierCounts = new Array(tiers).fill(baseCount);
        // Distribute remainder people to top tiers
        for (let i = 0; i < remainder; i++) {
            tierCounts[tiers - 1 - i] += 1;
        }

        let tierPayouts = new Array(tiers).fill(0);

        // 1. Calculate Base Payouts
        if (!useHalving) {
            if (totalWinners > 0) {
                const basePrize = Math.floor(netPrizePool / totalWinners);
                tierPayouts.fill(basePrize);
            }
        } else {
            // Halving Logic
            let totalShares = 0;
            for (let i = 0; i < tiers; i++) {
                const power = tiers - 1 - i;
                const multiplier = Math.pow(2, power);
                totalShares += tierCounts[i] * multiplier;
            }

            if (totalShares > 0) {
                const baseUnit = Math.floor(netPrizePool / totalShares);
                for (let i = 0; i < tiers; i++) {
                    const power = tiers - 1 - i;
                    tierPayouts[i] = baseUnit * Math.pow(2, power);
                }
            }
        }

        // 2. Optimization Loop (Spend loose change)
        // If not rounding to 10 yet, just try to spend every single gold piece
        let usedGold = 0;
        for (let i = 0; i < tiers; i++) usedGold += tierPayouts[i] * tierCounts[i];
        let leftoverGold = netPrizePool - usedGold;
        
        let changeMade = true;
        while (changeMade && leftoverGold > 0) {
            changeMade = false;
            for (let i = 0; i < tiers; i++) {
                const costToBump = tierCounts[i];
                if (leftoverGold >= costToBump) {
                    tierPayouts[i] += 1;
                    leftoverGold -= costToBump;
                    changeMade = true;
                }
            }
        }

        // 3. Rounding to 10 Logic (This creates the "Rounding Leftover")
        if (roundDown10) {
            // First, floor everyone to 10
            let roundingPot = leftoverGold; // Carry over any previous dust
            
            for (let i = 0; i < tiers; i++) {
                const originalVal = tierPayouts[i];
                const roundedVal = Math.floor(originalVal / 10) * 10;
                tierPayouts[i] = roundedVal;
                
                // Add the chopped off amount back to pot
                roundingPot += ((originalVal - roundedVal) * tierCounts[i]);
            }

            // Now try to redistribute that pot in chunks of 10
            changeMade = true;
            while (changeMade && roundingPot > 0) {
                changeMade = false;
                for (let i = 0; i < tiers; i++) {
                    const costToBump10 = tierCounts[i] * 10;
                    if (roundingPot >= costToBump10) {
                        tierPayouts[i] += 10;
                        roundingPot -= costToBump10;
                        changeMade = true;
                    }
                }
            }
            leftoverGold = roundingPot; // This is the final rounding leftover
        }

        // Generate HTML Output
        let tiersHtml = '';
        let totalPaidOut = 0;

        // Since the array logic puts lowest payout at index 0 or index last depending on halving, 
        // usually we want Tier 1 to be the highest paid.
        // Let's sort simply by payout amount descending for display.
        // We create objects to sort them
        let displayTiers = [];
        for(let i=0; i<tiers; i++) {
            displayTiers.push({ payout: tierPayouts[i], count: tierCounts[i] });
        }
        displayTiers.sort((a, b) => b.payout - a.payout);

        displayTiers.forEach((t, index) => {
            const subTotal = t.payout * t.count;
            totalPaidOut += subTotal;
            tiersHtml += `
            <div class="tier-row">
                <div>
                    <div class="tier-label">Tier ${index + 1}</div>
                    <div class="tier-detail">${t.count} people</div>
                </div>
                <div style="text-align:right">
                    <div class="tier-label" style="color:#007bff">${fmt(t.payout)} G</div>
                    <div class="tier-detail">Total: ${fmt(subTotal)} G</div>
                </div>
            </div>`;
        });

        const totalHouseTake = houseInitialFee + leftoverGold;
        
        const html = `
            <div class="result-header">
                <div class="result-row">
                    <span>Gross Pot:</span>
                    <span>${fmt(grossPot)}</span>
                </div>
                <div class="result-row">
                    <span>Initial House Fee (${housePercent}%):</span>
                    <span style="color:#d9534f">-${fmt(houseInitialFee)}</span>
                </div>
                <div class="result-row main">
                    <span>Net Prize Pool:</span>
                    <span>${fmt(netPrizePool)}</span>
                </div>
            </div>

            <div class="result-body">
                ${tiersHtml}
            </div>

            <div class="result-footer">
                <div class="result-row">
                    <span>Total Distributed to Players:</span>
                    <strong>${fmt(totalPaidOut)}</strong>
                </div>
                <div class="result-row">
                    <span>Rounding Leftovers (to House):</span>
                    <span>+${fmt(leftoverGold)}</span>
                </div>
                <div class="result-row main">
                    <span>Total House Take (Fee + Rounding):</span>
                    <span>${fmt(totalHouseTake)}</span>
                </div>
                <div class="reconciliation">
                    Check: Distributed (${fmt(totalPaidOut)}) + House (${fmt(totalHouseTake)}) = ${fmt(totalPaidOut + totalHouseTake)}
                </div>
            </div>
        `;

        resultArea.innerHTML = html;
        resultArea.classList.add('active');
    }
</script>

</body>
</html>